<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SafePost - Social Media</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        /* Claymorphism theme styles */
        :root {
            --primary-color: #ff85a2;
            --secondary-color: #fbb1bd;
            --background-color: #fff0f3;
            --text-color: #5d3e5f;
            --shadow-color: rgba(179, 119, 129, 0.4);
            --highlight-color: #ffd9e2;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
        }
        
        .clay-card {
            background-color: var(--secondary-color);
            border-radius: 16px;
            box-shadow: 
                8px 8px 16px var(--shadow-color),
                -8px -8px 16px rgba(255, 255, 255, 0.7);
            border: none;
            padding: 20px;
        }
        
        .clay-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            box-shadow: 
                4px 4px 10px var(--shadow-color),
                -2px -2px 10px rgba(255, 255, 255, 0.5);
            transition: all 0.2s ease;
        }
        
        .clay-button:hover {
            transform: translateY(-2px);
            box-shadow: 
                6px 6px 15px var(--shadow-color),
                -2px -2px 10px rgba(255, 255, 255, 0.7);
        }
        
        .clay-button:active {
            transform: translateY(1px);
            box-shadow: 
                2px 2px 5px var(--shadow-color),
                -1px -1px 5px rgba(255, 255, 255, 0.5);
        }
        
        .clay-input {
            background-color: var(--highlight-color);
            border: none;
            border-radius: 10px;
            padding: 12px 16px;
            color: var(--text-color);
            box-shadow: 
                inset 2px 2px 5px var(--shadow-color),
                inset -2px -2px 5px rgba(255, 255, 255, 0.7);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
        }
        
        .post-image {
            max-height: 500px;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 
                4px 4px 10px var(--shadow-color),
                -2px -2px 10px rgba(255, 255, 255, 0.5);
        }
        
        .user-profile-image {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 
                2px 2px 5px var(--shadow-color),
                -1px -1px 5px rgba(255, 255, 255, 0.5);
        }

        /* Mobile navigation */
        .mobile-nav {
            position: fixed;
            bottom: 0;
            width: 100%;
            display: flex;
            justify-content: space-around;
            background-color: var(--highlight-color);
            padding: 12px;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 15px var(--shadow-color);
            z-index: 100;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-color);
        }

        /* Profile styles */
        .profile-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .profile-pic {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 
                5px 5px 15px var(--shadow-color),
                -2px -2px 10px rgba(255, 255, 255, 0.7);
            margin-bottom: 15px;
        }

        .profile-stats {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin: 20px 0;
        }

        .stat-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .posts-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 20px;
        }

        .grid-item {
            aspect-ratio: 1/1;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 
                2px 2px 5px var(--shadow-color),
                -1px -1px 5px rgba(255, 255, 255, 0.5);
        }

        .grid-item img, .grid-item video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Stories */
        .stories-container {
            display: flex;
            overflow-x: auto;
            padding: 10px 0;
            margin-bottom: 15px;
        }

        .story {
            min-width: 70px;
            margin-right: 15px;
            text-align: center;
        }

        .story-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            padding: 2px;
            background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
            margin-bottom: 5px;
        }

        .story-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid white;
            object-fit: cover;
        }

        /* Search Results */
        .search-results {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            background-color: var(--highlight-color);
            border-radius: 12px;
            box-shadow: 
                4px 4px 10px var(--shadow-color),
                -2px -2px 10px rgba(255, 255, 255, 0.5);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            display: none;
        }

        /* Notifications */
        .notification {
            padding: 12px;
            border-bottom: 1px solid var(--secondary-color);
            display: flex;
            align-items: center;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--background-color);
            border-radius: 16px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 
                8px 8px 16px var(--shadow-color),
                -8px -8px 16px rgba(255, 255, 255, 0.7);
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading">
        <div class="clay-card p-8 flex flex-col items-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-primary"></div>
            <p class="mt-4">Loading...</p>
        </div>
    </div>

    <!-- Auth Section -->
    <div id="authSection" class="min-h-screen flex items-center justify-center p-4">
        <div class="clay-card w-full max-w-md">
            <h1 class="text-3xl font-bold mb-6 text-center text-primary">SafePost</h1>
            <div id="loginForm">
                <input type="text" id="loginUsername" placeholder="Username" class="clay-input w-full mb-4">
                <input type="password" id="loginPassword" placeholder="Password" class="clay-input w-full mb-4">
                <button onclick="login()" class="clay-button w-full">Login</button>
                <p class="text-center mt-4">Don't have an account? <a href="#" onclick="toggleForms()" class="font-bold text-primary">Register</a></p>
            </div>
            <div id="registerForm" class="hidden">
                <input type="text" id="regUsername" placeholder="Username" class="clay-input w-full mb-4">
                <input type="email" id="regEmail" placeholder="Email" class="clay-input w-full mb-4">
                <input type="password" id="regPassword" placeholder="Password" class="clay-input w-full mb-4">
                <button onclick="register()" class="clay-button w-full">Register</button>
                <p class="text-center mt-4">Already have an account? <a href="#" onclick="toggleForms()" class="font-bold text-primary">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden pb-20">
        <!-- Navigation -->
        <nav class="sticky top-0 bg-white/90 backdrop-blur-sm z-50 p-4 shadow-md">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-2xl font-bold text-primary">SafePost</h1>
                <div class="relative">
                    <input type="text" id="searchUser" placeholder="Search users..." class="clay-input w-full md:w-64">
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto px-4 pt-4">
            <!-- Different views -->
            <div id="homeView">
                <!-- Stories -->
                <div class="stories-container clay-card mb-6">
                    <div class="story">
                        <div class="story-avatar bg-gray-200">
                            <img src="https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces" alt="Your story">
                        </div>
                        <p class="text-xs">Your story</p>
                    </div>
                    <div id="storiesContainer"></div>
                </div>

                <!-- Create Post -->
                <div class="clay-card mb-8">
                    <textarea id="postText" placeholder="What's on your mind?" class="clay-input w-full mb-4"></textarea>
                    <div class="flex flex-wrap gap-4 mb-4">
                        <input type="file" id="mediaUpload" accept="image/*,video/*" class="hidden">
                        <button onclick="document.getElementById('mediaUpload').click()" class="clay-button flex items-center">
                            <i class="bi bi-image mr-2"></i> Add Media
                        </button>
                        <button onclick="createPost()" class="clay-button flex items-center">
                            <i class="bi bi-send mr-2"></i> Post
                        </button>
                    </div>
                    <div id="mediaPreview" class="hidden mt-4">
                        <img id="imagePreview" class="max-h-60 rounded hidden" alt="Preview">
                        <video id="videoPreview" class="max-h-60 rounded hidden" controls></video>
                    </div>
                </div>

                <!-- Feed -->
                <div id="feed" class="space-y-8"></div>
            </div>

            <div id="exploreView" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Explore</h2>
                <div id="exploreGrid" class="posts-grid"></div>
            </div>

            <div id="notificationsView" class="hidden">
                <h2 class="text-2xl font-bold mb-4">Notifications</h2>
                <div id="notificationsContainer" class="clay-card">
                    <!-- Notifications will be dynamically added here -->
                </div>
            </div>

            <div id="profileView" class="hidden">
                <div class="profile-header clay-card mb-6">
                    <img id="profilePic" src="https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces" alt="Profile picture" class="profile-pic">
                    <h2 id="profileUsername" class="text-xl font-bold">Username</h2>
                    <p id="profileBio" class="text-gray-600 mt-2">User bio goes here</p>

                    <div class="profile-stats">
                        <div class="stat-container">
                            <span id="postsCount" class="font-bold">0</span>
                            <span class="text-sm">Posts</span>
                        </div>
                        <div class="stat-container">
                            <span id="followersCount" class="font-bold">0</span>
                            <span class="text-sm cursor-pointer" onclick="showFollowersList()">Followers</span>
                        </div>
                        <div class="stat-container">
                            <span id="followingCount" class="font-bold">0</span>
                            <span class="text-sm cursor-pointer" onclick="showFollowingList()">Following</span>
                        </div>
                    </div>

                    <button id="profileActionBtn" class="clay-button w-2/3" onclick="toggleFollow()">Follow</button>
                </div>

                <div id="userPostsGrid" class="posts-grid"></div>
            </div>

            <div id="personalProfileView" class="hidden">
                <div class="profile-header clay-card mb-6">
                    <img id="personalProfilePic" src="https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces" alt="Profile picture" class="profile-pic">
                    <h2 id="personalProfileUsername" class="text-xl font-bold">Username</h2>
                    <p id="personalProfileBio" class="text-gray-600 mt-2">Your bio goes here</p>

                    <div class="profile-stats">
                        <div class="stat-container">
                            <span id="personalPostsCount" class="font-bold">0</span>
                            <span class="text-sm">Posts</span>
                        </div>
                        <div class="stat-container">
                            <span id="personalFollowersCount" class="font-bold">0</span>
                            <span class="text-sm cursor-pointer" onclick="showFollowersList(true)">Followers</span>
                        </div>
                        <div class="stat-container">
                            <span id="personalFollowingCount" class="font-bold">0</span>
                            <span class="text-sm cursor-pointer" onclick="showFollowingList(true)">Following</span>
                        </div>
                    </div>

                    <button class="clay-button w-2/3" onclick="editProfile()">Edit Profile</button>
                </div>

                <div id="personalPostsGrid" class="posts-grid"></div>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav md:hidden">
            <div class="nav-item" onclick="showView('homeView')">
                <i class="bi bi-house-door text-xl"></i>
                <span class="text-xs">Home</span>
            </div>
            <div class="nav-item" onclick="showView('exploreView')">
                <i class="bi bi-search text-xl"></i>
                <span class="text-xs">Explore</span>
            </div>
            <div class="nav-item" onclick="showView('notificationsView'); loadNotifications();">
                <i class="bi bi-bell text-xl"></i>
                <span class="text-xs">Activity</span>
            </div>
            <div class="nav-item" onclick="loadPersonalProfile()">
                <i class="bi bi-person-circle text-xl"></i>
                <span class="text-xs">Profile</span>
            </div>
            <div class="nav-item" onclick="logout()">
                <i class="bi bi-box-arrow-right text-xl"></i>
                <span class="text-xs">Logout</span>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="followersModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Followers</h2>
                <button onclick="closeModal('followersModal')" class="text-xl">&times;</button>
            </div>
            <div id="followersList" class="max-h-96 overflow-y-auto">
                <!-- Followers will be listed here -->
            </div>
        </div>
    </div>

    <div id="followingModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Following</h2>
                <button onclick="closeModal('followingModal')" class="text-xl">&times;</button>
            </div>
            <div id="followingList" class="max-h-96 overflow-y-auto">
                <!-- Following users will be listed here -->
            </div>
        </div>
    </div>

    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Edit Profile</h2>
                <button onclick="closeModal('editProfileModal')" class="text-xl">&times;</button>
            </div>
            <div class="mb-4">
                <input type="file" id="profilePicUpload" accept="image/*" class="hidden">
                <div class="flex justify-center">
                    <img id="profilePicPreview" src="https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces" alt="Profile preview" class="profile-pic cursor-pointer" onclick="document.getElementById('profilePicUpload').click()">
                </div>
                <p class="text-center text-sm mt-2">Click on the image to change profile picture</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Bio</label>
                <textarea id="bioInput" class="clay-input w-full" rows="3"></textarea>
            </div>
            <button onclick="saveProfile()" class="clay-button w-full">Save Changes</button>
        </div>
    </div>

    <div id="postModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Post</h2>
                <button onclick="closeModal('postModal')" class="text-xl">&times;</button>
            </div>
            <div id="postModalContent">
                <!-- Post details will go here -->
            </div>
        </div>
    </div>
    
    <div id="contentWarningModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-red-600">Content Warning</h2>
                <button onclick="closeModal('contentWarningModal')" class="text-xl">&times;</button>
            </div>
            <div class="mb-6">
                <p id="warningMessage" class="mb-4"></p>
                <p class="text-sm text-gray-600">SafePost aims to maintain a positive and safe environment for all users. Please ensure your content follows our community guidelines.</p>
            </div>
            <button onclick="closeModal('contentWarningModal')" class="clay-button w-full">I Understand</button>
        </div>
    </div>

    <script>
        let currentUser = null;
        let viewingUser = null;
        let currentView = 'homeView';
        const appSlug = 'safepost-123456';

        // Utility Functions
        const showLoading = () => document.querySelector('.loading').style.display = 'block';
        const hideLoading = () => document.querySelector('.loading').style.display = 'none';
        const toggleForms = () => {
            document.getElementById('loginForm').classList.toggle('hidden');
            document.getElementById('registerForm').classList.toggle('hidden');
        };

        const showView = (viewId) => {
            // Hide all views
            document.querySelectorAll('#homeView, #exploreView, #notificationsView, #profileView, #personalProfileView').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Show selected view
            document.getElementById(viewId).classList.remove('hidden');
            currentView = viewId;

            if(viewId === 'exploreView') {
                loadExploreGrid();
            }
        };

        const closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        const openModal = (modalId) => {
            document.getElementById(modalId).style.display = 'flex';
        };
        
        // Content moderation functions
        async function moderateContent(text, mediaType = null, mediaUrl = null) {
            if (!text && !mediaUrl) return { safe: true };
            
            try {
                let messages = [
                    {
                        role: "user",
                        content: [
                            {
                                type: "text",
                                text: `Please analyze the following content for any inappropriate material like nudity, violence, hate speech, or offensive language. Respond with 'UNSAFE' if the content is inappropriate, along with the specific reason, or 'SAFE' if it's appropriate for all audiences:\n\n${text || ""}`
                            }
                        ]
                    }
                ];
                
                // If there's media, and it's an image, analyze it too
                if (mediaUrl && mediaType === 'image') {
                    messages[0].content.push({
                        type: "image_url",
                        image_url: {
                            url: mediaUrl
                        }
                    });
                }
                
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/ai', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ messages })
                });
                
                const data = await response.json();
                const aiResponse = data.message.toLowerCase();
                
                if (aiResponse.includes('unsafe')) {
                    // Extract the reason for being unsafe
                    let reason = "This content may violate SafePost community guidelines.";
                    
                    // Try to extract more specific reason
                    if (aiResponse.includes('because')) {
                        const reasonParts = aiResponse.split('because');
                        if (reasonParts.length > 1) {
                            reason = "This content was flagged because" + reasonParts[1].trim();
                        }
                    }
                    
                    return { 
                        safe: false,
                        reason
                    };
                }
                
                return { safe: true };
            } catch (error) {
                console.error('Content moderation error:', error);
                // If moderation fails, we'll allow the content but log the error
                return { safe: true };
            }
        }

        function showContentWarning(reason) {
            document.getElementById('warningMessage').textContent = reason;
            openModal('contentWarningModal');
        }

        // Auth Functions
        async function register() {
            showLoading();
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if(!username || !email || !password) {
                alert('Please fill all fields');
                hideLoading();
                return;
            }

            try {
                // Check if username already exists
                const checkResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { username }
                    })
                });

                const checkData = await checkResponse.json();
                if(checkData.success && checkData.result.length > 0) {
                    alert('Username already taken');
                    hideLoading();
                    return;
                }

                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'create',
                        collection: 'users',
                        data: { 
                            username, 
                            email, 
                            password, 
                            followers: [], 
                            following: [],
                            bio: '',
                            profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces', // Default profile pic
                            notifications: []
                        }
                    })
                });

                const data = await response.json();
                if(data.success) {
                    alert('Registration successful! Please login.');
                    toggleForms();
                }
            } catch (error) {
                console.error('Registration error:', error);
                alert('Registration failed. Please try again.');
            }
            hideLoading();
        }

        async function login() {
            showLoading();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;

            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { username, password }
                    })
                });

                const data = await response.json();
                if(data.success && data.result.length > 0) {
                    currentUser = data.result[0];
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');
                    loadFeed();
                    loadStories();
                } else {
                    alert('Invalid credentials!');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
            hideLoading();
        }

        function logout() {
            currentUser = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Post Functions
        async function createPost() {
            showLoading();
            const text = document.getElementById('postText').value;
            const mediaUpload = document.getElementById('mediaUpload').files[0];

            if(!text && !mediaUpload) {
                alert('Please add text or media to your post');
                hideLoading();
                return;
            }

            try {
                let mediaUrl = '';
                let mediaType = '';
                if(mediaUpload) {
                    const formData = new FormData();
                    formData.append('file', mediaUpload);
                    formData.append('userId', currentUser.username);
                    formData.append('appSlug', appSlug);

                    const uploadResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/storage/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                        },
                        body: formData
                    });

                    const uploadData = await uploadResponse.json();
                    if(uploadData.success) {
                        mediaUrl = uploadData.url;
                        mediaType = mediaUpload.type.startsWith('image/') ? 'image' : 'video';
                    }
                }
                
                // Moderate content before posting
                const moderationResult = await moderateContent(text, mediaType, mediaUrl);
                
                if (!moderationResult.safe) {
                    showContentWarning(moderationResult.reason);
                    // Delete the uploaded media if it exists
                    if (mediaUrl) {
                        // Extract path from URL
                        const urlParts = mediaUrl.split('/');
                        const filePath = urlParts.slice(urlParts.indexOf(appSlug)).join('/');
                        
                        try {
                            await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/storage/delete', {
                                method: 'DELETE',
                                headers: {
                                    'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    userId: currentUser.username,
                                    appSlug,
                                    filePath
                                })
                            });
                        } catch (deleteError) {
                            console.error('Failed to delete inappropriate media:', deleteError);
                        }
                    }
                    hideLoading();
                    return;
                }

                await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'create',
                        collection: 'posts',
                        data: {
                            username: currentUser.username,
                            text,
                            mediaUrl,
                            mediaType,
                            likes: [],
                            comments: [],
                            timestamp: new Date().toISOString()
                        }
                    })
                });

                document.getElementById('postText').value = '';
                document.getElementById('mediaUpload').value = '';
                document.getElementById('mediaPreview').classList.add('hidden');
                document.getElementById('imagePreview').classList.add('hidden');
                document.getElementById('videoPreview').classList.add('hidden');
                
                await loadFeed();
                
                // Reload profile if on personal profile
                if(currentView === 'personalProfileView') {
                    loadPersonalProfile();
                }
            } catch (error) {
                console.error('Post creation error:', error);
                alert('Failed to create post. Please try again.');
            }
            hideLoading();
        }

        async function loadFeed() {
            showLoading();
            try {
                // First get users the current user is following
                const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { _id: currentUser._id }
                    })
                });

                const userData = await userResponse.json();
                if(userData.success && userData.result.length > 0) {
                    // Update current user
                    currentUser = userData.result[0];
                    
                    // Get all posts
                    const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'read',
                            collection: 'posts'
                        })
                    });

                    const data = await response.json();
                    if(data.success) {
                        const feed = document.getElementById('feed');
                        feed.innerHTML = '';

                        // Get all users for profile pics
                        const usersResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                appSlug,
                                action: 'read',
                                collection: 'users'
                            })
                        });

                        const usersData = await usersResponse.json();
                        const users = usersData.success ? usersData.result : [];
                        const userMap = {};
                        users.forEach(user => {
                            userMap[user.username] = user;
                        });

                        // Filter posts to show:
                        // 1. Posts by users the current user follows
                        // 2. Current user's own posts
                        const followingUsernames = currentUser.following;
                        const relevantPosts = data.result.filter(post => 
                            followingUsernames.includes(post.username) || 
                            post.username === currentUser.username
                        );

                        if(relevantPosts.length === 0) {
                            // Show all posts if not following anyone yet
                            relevantPosts.push(...data.result);
                        }

                        // Sort by timestamp (newest first)
                        relevantPosts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                        relevantPosts.forEach(post => {
                            const postUser = userMap[post.username] || { 
                                profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'
                            };
                            
                            const timeAgo = formatTimeAgo(new Date(post.timestamp));
                            const postElement = document.createElement('div');
                            postElement.className = 'clay-card';
                            postElement.innerHTML = `
                                <div class="flex items-center mb-4">
                                    <img src="${postUser.profilePic}" alt="${post.username}" class="user-profile-image mr-3">
                                    <div>
                                        <div>
                                            <span class="font-semibold cursor-pointer" onclick="loadUserProfile('${post.username}')">${post.username}</span>
                                            ${currentUser.username !== post.username ? 
                                                (currentUser.following.includes(post.username) ? 
                                                    `<button class="text-xs bg-gray-200 rounded px-2 py-1 ml-2" onclick="unfollowUser('${post.username}')">Unfollow</button>` : 
                                                    `<button class="text-xs bg-pink-200 rounded px-2 py-1 ml-2" onclick="followUser('${post.username}')">Follow</button>`
                                                ) : ''
                                            }
                                        </div>
                                        <span class="text-xs text-gray-500">${timeAgo}</span>
                                    </div>
                                </div>
                                ${post.text ? `<p class="mb-4">${post.text}</p>` : ''}
                                ${post.mediaUrl ? (post.mediaType === 'image' ? 
                                    `<img src="${post.mediaUrl}" class="post-image mb-4 w-full cursor-pointer" onclick="showPostDetail('${post._id}')" alt="Post image">` :
                                    `<video src="${post.mediaUrl}" class="post-image mb-4 w-full" controls></video>`)
                                : ''}
                                <div class="flex items-center space-x-4">
                                    <button onclick="toggleLike('${post._id}')" class="flex items-center">
                                        <i class="bi ${post.likes.includes(currentUser.username) ? 'bi-heart-fill text-red-500' : 'bi-heart'} text-xl"></i>
                                        <span class="ml-2">${post.likes.length}</span>
                                    </button>
                                    <button onclick="toggleComments('${post._id}')" class="flex items-center">
                                        <i class="bi bi-chat text-xl"></i>
                                        <span class="ml-2">${post.comments.length}</span>
                                    </button>
                                </div>
                                ${post.likes.length > 0 ? `
                                    <div class="mt-3 text-sm">
                                        Liked by <span class="font-semibold">${post.likes[0]}</span>
                                        ${post.likes.length > 1 ? ` and <span class="font-semibold">${post.likes.length - 1} others</span>` : ''}
                                    </div>
                                ` : ''}
                                <div id="comments-${post._id}" class="hidden mt-4">
                                    <div class="space-y-2 mb-4">
                                        ${post.comments.map(comment => {
                                            const commentUser = userMap[comment.username] || {
                                                profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'
                                            };
                                            return `
                                                <div class="flex items-start">
                                                    <img src="${commentUser.profilePic}" alt="${comment.username}" class="w-8 h-8 rounded-full mr-2">
                                                    <div class="bg-white/10 p-2 rounded flex-1">
                                                        <span class="font-semibold cursor-pointer" onclick="loadUserProfile('${comment.username}')">${comment.username}:</span> ${comment.text}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    <div class="flex">
                                        <input type="text" placeholder="Add a comment..." id="comment-input-${post._id}"
                                            class="clay-input flex-1 rounded-r-none">
                                        <button onclick="addComment('${post._id}')"
                                            class="clay-button rounded-l-none">Post</button>
                                    </div>
                                </div>
                            `;
                            feed.appendChild(postElement);
                        });
                    }
                }
            } catch (error) {
                console.error('Feed loading error:', error);
                alert('Failed to load feed. Please try again.');
            }
            hideLoading();
        }

        async function toggleLike(postId) {
            showLoading();
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'posts',
                        conditions: { _id: postId }
                    })
                });

                const data = await response.json();
                if(data.success && data.result.length > 0) {
                    const post = data.result[0];
                    const likes = post.likes || [];
                    const userIndex = likes.indexOf(currentUser.username);
                    
                    if(userIndex === -1) {
                        likes.push(currentUser.username);
                        
                        // Add notification for the post owner if it's not the current user
                        if(post.username !== currentUser.username) {
                            await addNotification(post.username, 'like', currentUser.username, postId);
                        }
                    } else {
                        likes.splice(userIndex, 1);
                    }

                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'posts',
                            conditions: { _id: postId },
                            data: { likes }
                        })
                    });

                    // Refresh content based on current view
                    if(currentView === 'homeView') {
                        loadFeed();
                    } else if(currentView === 'profileView') {
                        loadUserProfile(viewingUser.username);
                    } else if(currentView === 'personalProfileView') {
                        loadPersonalProfile();
                    } else if(document.getElementById('postModal').style.display === 'flex') {
                        showPostDetail(postId);
                    }
                }
            } catch (error) {
                console.error('Like toggle error:', error);
                alert('Failed to toggle like. Please try again.');
            }
            hideLoading();
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            commentsSection.classList.toggle('hidden');
        }

        async function addComment(postId) {
            showLoading();
            const commentText = document.getElementById(`comment-input-${postId}`).value;
            
            if(!commentText.trim()) {
                hideLoading();
                return;
            }
            
            try {
                // Moderate comment
                const moderationResult = await moderateContent(commentText);
                
                if (!moderationResult.safe) {
                    showContentWarning(moderationResult.reason);
                    hideLoading();
                    return;
                }
                
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'posts',
                        conditions: { _id: postId }
                    })
                });

                const data = await response.json();
                if(data.success && data.result.length > 0) {
                    const post = data.result[0];
                    const comments = post.comments || [];
                    comments.push({
                        username: currentUser.username,
                        text: commentText,
                        timestamp: new Date().toISOString()
                    });

                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'posts',
                            conditions: { _id: postId },
                            data: { comments }
                        })
                    });

                    // Add notification for the post owner if it's not the current user
                    if(post.username !== currentUser.username) {
                        await addNotification(post.username, 'comment', currentUser.username, postId);
                    }

                    // Refresh content based on current view
                    if(currentView === 'homeView') {
                        loadFeed();
                    } else if(currentView === 'profileView') {
                        loadUserProfile(viewingUser.username);
                    } else if(currentView === 'personalProfileView') {
                        loadPersonalProfile();
                    } else if(document.getElementById('postModal').style.display === 'flex') {
                        showPostDetail(postId);
                    }
                }
            } catch (error) {
                console.error('Comment addition error:', error);
                alert('Failed to add comment. Please try again.');
            }
            hideLoading();
        }

        // Profile Functions
        async function loadUserProfile(username) {
            if(username === currentUser.username) {
                return loadPersonalProfile();
            }

            showLoading();
            document.getElementById('profileView').classList.remove('hidden');
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('exploreView').classList.add('hidden');
            document.getElementById('notificationsView').classList.add('hidden');
            document.getElementById('personalProfileView').classList.add('hidden');
            currentView = 'profileView';

            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { username }
                    })
                });

                const data = await response.json();
                if(data.success && data.result.length > 0) {
                    viewingUser = data.result[0];
                    
                    // Update UI with user info
                    document.getElementById('profileUsername').textContent = viewingUser.username;
                    document.getElementById('profileBio').textContent = viewingUser.bio || 'No bio yet';
                    document.getElementById('profilePic').src = viewingUser.profilePic || 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces';
                    
                    // Update follow button
                    const isFollowing = currentUser.following.includes(viewingUser.username);
                    const followBtn = document.getElementById('profileActionBtn');
                    followBtn.textContent = isFollowing ? 'Unfollow' : 'Follow';
                    followBtn.onclick = isFollowing ? 
                        () => unfollowUser(viewingUser.username) : 
                        () => followUser(viewingUser.username);
                    
                    // Get user's posts
                    const postsResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'read',
                            collection: 'posts',
                            conditions: { username }
                        })
                    });

                    const postsData = await postsResponse.json();
                    const posts = postsData.success ? postsData.result : [];
                    
                    // Update stats
                    document.getElementById('postsCount').textContent = posts.length;
                    document.getElementById('followersCount').textContent = viewingUser.followers?.length || 0;
                    document.getElementById('followingCount').textContent = viewingUser.following?.length || 0;
                    
                    // Render posts grid
                    const postsGrid = document.getElementById('userPostsGrid');
                    postsGrid.innerHTML = '';
                    
                    posts.forEach(post => {
                        if(post.mediaUrl) {
                            const postEl = document.createElement('div');
                            postEl.className = 'grid-item cursor-pointer';
                            postEl.onclick = () => showPostDetail(post._id);
                            
                            if(post.mediaType === 'image') {
                                postEl.innerHTML = `<img src="${post.mediaUrl}" alt="Post">`;
                            } else {
                                postEl.innerHTML = `
                                    <video>
                                        <source src="${post.mediaUrl}" type="video/mp4">
                                    </video>
                                    <i class="bi bi-play-fill absolute inset-0 flex items-center justify-center text-4xl text-white"></i>
                                `;
                            }
                            postsGrid.appendChild(postEl);
                        }
                    });
                    
                    if(posts.length === 0) {
                        postsGrid.innerHTML = '<p class="text-center py-4">No posts yet</p>';
                    }
                } else {
                    alert('User not found');
                }
            } catch (error) {
                console.error('Profile loading error:', error);
                alert('Failed to load profile. Please try again.');
            }
            hideLoading();
        }

        async function loadPersonalProfile() {
            showLoading();
            document.getElementById('personalProfileView').classList.remove('hidden');
            document.getElementById('homeView').classList.add('hidden');
            document.getElementById('exploreView').classList.add('hidden');
            document.getElementById('notificationsView').classList.add('hidden');
            document.getElementById('profileView').classList.add('hidden');
            currentView = 'personalProfileView';

            try {
                // Reload current user data
                const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { _id: currentUser._id }
                    })
                });

                const userData = await userResponse.json();
                if(userData.success && userData.result.length > 0) {
                    currentUser = userData.result[0];
                    
                    // Update UI with user info
                    document.getElementById('personalProfileUsername').textContent = currentUser.username;
                    document.getElementById('personalProfileBio').textContent = currentUser.bio || 'No bio yet';
                    document.getElementById('personalProfilePic').src = currentUser.profilePic || 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces';
                    
                    // Get user's posts
                    const postsResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'read',
                            collection: 'posts',
                            conditions: { username: currentUser.username }
                        })
                    });

                    const postsData = await postsResponse.json();
                    const posts = postsData.success ? postsData.result : [];
                    
                    // Update stats
                    document.getElementById('personalPostsCount').textContent = posts.length;
                    document.getElementById('personalFollowersCount').textContent = currentUser.followers?.length || 0;
                    document.getElementById('personalFollowingCount').textContent = currentUser.following?.length || 0;
                    
                    // Render posts grid
                    const postsGrid = document.getElementById('personalPostsGrid');
                    postsGrid.innerHTML = '';
                    
                    posts.forEach(post => {
                        if(post.mediaUrl) {
                            const postEl = document.createElement('div');
                            postEl.className = 'grid-item cursor-pointer';
                            postEl.onclick = () => showPostDetail(post._id);
                            
                            if(post.mediaType === 'image') {
                                postEl.innerHTML = `<img src="${post.mediaUrl}" alt="Post">`;
                            } else {
                                postEl.innerHTML = `
                                    <video>
                                        <source src="${post.mediaUrl}" type="video/mp4">
                                    </video>
                                    <i class="bi bi-play-fill absolute inset-0 flex items-center justify-center text-4xl text-white"></i>
                                `;
                            }
                            postsGrid.appendChild(postEl);
                        }
                    });
                    
                    if(posts.length === 0) {
                        postsGrid.innerHTML = '<p class="text-center py-4">No posts yet</p>';
                    }
                }
            } catch (error) {
                console.error('Profile loading error:', error);
                alert('Failed to load profile. Please try again.');
            }
            hideLoading();
        }

        async function followUser(username) {
            showLoading();
            try {
                // First update current user's following list
                const following = [...currentUser.following, username];
                await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'update',
                        collection: 'users',
                        conditions: { _id: currentUser._id },
                        data: { following }
                    })
                });

                // Then update the target user's followers list
                const targetUserResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { username }
                    })
                });

                const targetUserData = await targetUserResponse.json();
                if(targetUserData.success && targetUserData.result.length > 0) {
                    const targetUser = targetUserData.result[0];
                    const followers = [...(targetUser.followers || []), currentUser.username];
                    
                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'users',
                            conditions: { username },
                            data: { followers }
                        })
                    });

                    // Add notification
                    await addNotification(username, 'follow', currentUser.username);
                }

                // Update local currentUser
                currentUser.following = following;

                // Refresh the current view
                if(currentView === 'profileView') {
                    loadUserProfile(username);
                } else if(currentView === 'homeView') {
                    loadFeed();
                }
            } catch (error) {
                console.error('Follow error:', error);
                alert('Failed to follow user. Please try again.');
            }
            hideLoading();
        }

        async function unfollowUser(username) {
            showLoading();
            try {
                // First update current user's following list
                const following = currentUser.following.filter(u => u !== username);
                await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'update',
                        collection: 'users',
                        conditions: { _id: currentUser._id },
                        data: { following }
                    })
                });

                // Then update the target user's followers list
                const targetUserResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { username }
                    })
                });

                const targetUserData = await targetUserResponse.json();
                if(targetUserData.success && targetUserData.result.length > 0) {
                    const targetUser = targetUserData.result[0];
                    const followers = (targetUser.followers || []).filter(u => u !== currentUser.username);
                    
                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'users',
                            conditions: { username },
                            data: { followers }
                        })
                    });
                }

                // Update local currentUser
                currentUser.following = following;

                // Refresh the current view
                if(currentView === 'profileView') {
                    loadUserProfile(username);
                } else if(currentView === 'homeView') {
                    loadFeed();
                }
            } catch (error) {
                console.error('Unfollow error:', error);
                alert('Failed to unfollow user. Please try again.');
            }
            hideLoading();
        }

        // Followers/Following Lists
        async function showFollowersList(isPersonal = false) {
            showLoading();
            try {
                const targetUser = isPersonal ? currentUser : viewingUser;
                const followersList = document.getElementById('followersList');
                followersList.innerHTML = '';

                if(!targetUser.followers || targetUser.followers.length === 0) {
                    followersList.innerHTML = '<p class="text-center py-4">No followers yet</p>';
                } else {
                    for(let username of targetUser.followers) {
                        const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                appSlug,
                                action: 'read',
                                collection: 'users',
                                conditions: { username }
                            })
                        });

                        const userData = await userResponse.json();
                        if(userData.success && userData.result.length > 0) {
                            const user = userData.result[0];
                            const isFollowing = currentUser.following.includes(username);
                            
                            const userItem = document.createElement('div');
                            userItem.className = 'flex items-center justify-between p-3 border-b border-gray-200';
                            userItem.innerHTML = `
                                <div class="flex items-center cursor-pointer" onclick="loadUserProfile('${username}'); closeModal('followersModal');">
                                    <img src="${user.profilePic || 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'}" alt="${username}" class="w-10 h-10 rounded-full mr-3">
                                    <div>
                                        <p class="font-semibold">${username}</p>
                                    </div>
                                </div>
                                ${username !== currentUser.username ? 
                                    (isFollowing ? 
                                        `<button class="clay-button text-xs" onclick="unfollowUser('${username}')">Unfollow</button>` : 
                                        `<button class="clay-button text-xs" onclick="followUser('${username}')">Follow</button>`
                                    ) : ''}
                            `;
                            followersList.appendChild(userItem);
                        }
                    }
                }
                
                openModal('followersModal');
            } catch (error) {
                console.error('Followers list error:', error);
                alert('Failed to load followers. Please try again.');
            }
            hideLoading();
        }

        async function showFollowingList(isPersonal = false) {
            showLoading();
            try {
                const targetUser = isPersonal ? currentUser : viewingUser;
                const followingList = document.getElementById('followingList');
                followingList.innerHTML = '';

                if(!targetUser.following || targetUser.following.length === 0) {
                    followingList.innerHTML = '<p class="text-center py-4">Not following anyone yet</p>';
                } else {
                    for(let username of targetUser.following) {
                        const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                appSlug,
                                action: 'read',
                                collection: 'users',
                                conditions: { username }
                            })
                        });

                        const userData = await userResponse.json();
                        if(userData.success && userData.result.length > 0) {
                            const user = userData.result[0];
                            const isFollowing = currentUser.following.includes(username);
                            
                            const userItem = document.createElement('div');
                            userItem.className = 'flex items-center justify-between p-3 border-b border-gray-200';
                            userItem.innerHTML = `
                                <div class="flex items-center cursor-pointer" onclick="loadUserProfile('${username}'); closeModal('followingModal');">
                                    <img src="${user.profilePic || 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'}" alt="${username}" class="w-10 h-10 rounded-full mr-3">
                                    <div>
                                        <p class="font-semibold">${username}</p>
                                    </div>
                                </div>
                                ${username !== currentUser.username ? 
                                    (isFollowing ? 
                                        `<button class="clay-button text-xs" onclick="unfollowUser('${username}')">Unfollow</button>` : 
                                        `<button class="clay-button text-xs" onclick="followUser('${username}')">Follow</button>`
                                    ) : ''}
                            `;
                            followingList.appendChild(userItem);
                        }
                    }
                }
                
                openModal('followingModal');
            } catch (error) {
                console.error('Following list error:', error);
                alert('Failed to load following users. Please try again.');
            }
            hideLoading();
        }

        // Profile editing
        function editProfile() {
            document.getElementById('profilePicPreview').src = currentUser.profilePic || 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces';
            document.getElementById('bioInput').value = currentUser.bio || '';
            openModal('editProfileModal');
        }

        async function saveProfile() {
            showLoading();
            try {
                const bio = document.getElementById('bioInput').value;
                const profilePicFile = document.getElementById('profilePicUpload').files[0];
                
                // Moderate bio content
                if (bio) {
                    const moderationResult = await moderateContent(bio);
                    if (!moderationResult.safe) {
                        showContentWarning(moderationResult.reason);
                        hideLoading();
                        return;
                    }
                }
                
                let profilePic = currentUser.profilePic;
                
                if(profilePicFile) {
                    const formData = new FormData();
                    formData.append('file', profilePicFile);
                    formData.append('userId', currentUser.username);
                    formData.append('appSlug', appSlug);

                    const uploadResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/storage/upload', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2'
                        },
                        body: formData
                    });

                    const uploadData = await uploadResponse.json();
                    if(uploadData.success) {
                        // Check if profile picture contains inappropriate content
                        const moderationResult = await moderateContent("", "image", uploadData.url);
                        if (!moderationResult.safe) {
                            showContentWarning(moderationResult.reason);
                            
                            // Delete the uploaded pic
                            try {
                                await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/storage/delete', {
                                    method: 'DELETE',
                                    headers: {
                                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        userId: currentUser.username,
                                        appSlug,
                                        filePath: uploadData.path
                                    })
                                });
                            } catch (deleteError) {
                                console.error('Failed to delete inappropriate profile pic:', deleteError);
                            }
                            
                            hideLoading();
                            return;
                        }
                        
                        profilePic = uploadData.url;
                    }
                }

                await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'update',
                        collection: 'users',
                        conditions: { _id: currentUser._id },
                        data: { bio, profilePic }
                    })
                });

                currentUser.bio = bio;
                currentUser.profilePic = profilePic;
                
                closeModal('editProfileModal');
                loadPersonalProfile();
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Failed to update profile. Please try again.');
            }
            hideLoading();
        }

        // Media preview
        document.getElementById('mediaUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const preview = document.getElementById('mediaPreview');
            const imagePreview = document.getElementById('imagePreview');
            const videoPreview = document.getElementById('videoPreview');

            preview.classList.remove('hidden');
            
            if(file.type.startsWith('image/')) {
                imagePreview.classList.remove('hidden');
                videoPreview.classList.add('hidden');
                imagePreview.src = URL.createObjectURL(file);
            } else if(file.type.startsWith('video/')) {
                imagePreview.classList.add('hidden');
                videoPreview.classList.remove('hidden');
                videoPreview.src = URL.createObjectURL(file);
            }
        });

        // Profile pic preview
        document.getElementById('profilePicUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;

            const preview = document.getElementById('profilePicPreview');
            preview.src = URL.createObjectURL(file);
        });

        // Search functionality
        document.getElementById('searchUser').addEventListener('input', async function(e) {
            const searchTerm = e.target.value;
            const searchResults = document.getElementById('searchResults');
            
            if(!searchTerm) {
                searchResults.style.display = 'none';
                return;
            }

            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { username: { $regex: searchTerm, $options: 'i' } }
                    })
                });

                const data = await response.json();
                if(data.success) {
                    searchResults.innerHTML = '';
                    searchResults.style.display = 'block';
                    
                    if(data.result.length === 0) {
                        searchResults.innerHTML = '<p class="p-3 text-center">No users found</p>';
                    } else {
                        data.result.forEach(user => {
                            const userItem = document.createElement('div');
                            userItem.className = 'flex items-center p-3 hover:bg-pink-100 cursor-pointer border-b border-gray-200';
                            userItem.innerHTML = `
                                <img src="${user.profilePic || 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'}" alt="${user.username}" class="w-10 h-10 rounded-full mr-3">
                                <p class="font-semibold">${user.username}</p>
                            `;
                            userItem.addEventListener('click', () => {
                                loadUserProfile(user.username);
                                searchResults.style.display = 'none';
                                document.getElementById('searchUser').value = '';
                            });
                            searchResults.appendChild(userItem);
                        });
                    }
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        });

        // Hide search results when clicking elsewhere
        document.addEventListener('click', function(e) {
            const searchResults = document.getElementById('searchResults');
            const searchInput = document.getElementById('searchUser');
            if(e.target !== searchInput && !searchResults.contains(e.target)) {
                searchResults.style.display = 'none';
            }
        });

        // Post detail
        async function showPostDetail(postId) {
            showLoading();
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'posts',
                        conditions: { _id: postId }
                    })
                });

                const data = await response.json();
                if(data.success && data.result.length > 0) {
                    const post = data.result[0];
                    
                    // Get post owner info
                    const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'read',
                            collection: 'users',
                            conditions: { username: post.username }
                        })
                    });

                    const userData = await userResponse.json();
                    const user = userData.success && userData.result.length > 0 ? userData.result[0] : {
                        profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'
                    };

                    // Map of users for comments
                    const userMap = {};
                    userMap[post.username] = user;

                    // Get comment user profiles if there are comments
                    if(post.comments && post.comments.length > 0) {
                        const commentUsernames = [...new Set(post.comments.map(c => c.username))];
                        for(let username of commentUsernames) {
                            if(username === post.username) continue; // Already have this user
                            
                            const commentUserResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                                method: 'POST',
                                headers: {
                                    'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    appSlug,
                                    action: 'read',
                                    collection: 'users',
                                    conditions: { username }
                                })
                            });

                            const commentUserData = await commentUserResponse.json();
                            if(commentUserData.success && commentUserData.result.length > 0) {
                                userMap[username] = commentUserData.result[0];
                            } else {
                                userMap[username] = {
                                    profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'
                                };
                            }
                        }
                    }
                    
                    const timeAgo = formatTimeAgo(new Date(post.timestamp));
                    const postModalContent = document.getElementById('postModalContent');
                    postModalContent.innerHTML = `
                        <div class="flex items-center mb-4">
                            <img src="${user.profilePic}" alt="${post.username}" class="user-profile-image mr-3">
                            <div>
                                <div>
                                    <span class="font-semibold cursor-pointer" onclick="loadUserProfile('${post.username}'); closeModal('postModal');">${post.username}</span>
                                    ${currentUser.username !== post.username ? 
                                        (currentUser.following.includes(post.username) ? 
                                            `<button class="text-xs bg-gray-200 rounded px-2 py-1 ml-2" onclick="unfollowUser('${post.username}')">Unfollow</button>` : 
                                            `<button class="text-xs bg-pink-200 rounded px-2 py-1 ml-2" onclick="followUser('${post.username}')">Follow</button>`
                                        ) : ''
                                    }
                                </div>
                                <span class="text-xs text-gray-500">${timeAgo}</span>
                            </div>
                        </div>
                        
                        ${post.mediaUrl ? (post.mediaType === 'image' ? 
                            `<img src="${post.mediaUrl}" class="post-image mb-4 w-full" alt="Post image">` :
                            `<video src="${post.mediaUrl}" class="post-image mb-4 w-full" controls></video>`)
                        : ''}
                        
                        ${post.text ? `<p class="mb-4">${post.text}</p>` : ''}
                        
                        <div class="flex items-center space-x-4 mt-4">
                            <button onclick="toggleLike('${post._id}')" class="flex items-center">
                                <i class="bi ${post.likes.includes(currentUser.username) ? 'bi-heart-fill text-red-500' : 'bi-heart'} text-xl"></i>
                                <span class="ml-2">${post.likes.length}</span>
                            </button>
                            <button class="flex items-center">
                                <i class="bi bi-chat text-xl"></i>
                                <span class="ml-2">${post.comments.length}</span>
                            </button>
                        </div>
                        
                        ${post.likes.length > 0 ? `
                            <div class="mt-3 text-sm">
                                Liked by <span class="font-semibold">${post.likes[0]}</span>
                                ${post.likes.length > 1 ? ` and <span class="font-semibold">${post.likes.length - 1} others</span>` : ''}
                            </div>
                        ` : ''}
                        
                        <hr class="my-4 border-gray-300">
                        
                        <div class="space-y-3 mb-4 max-h-64 overflow-y-auto">
                            ${post.comments.length > 0 ? post.comments.map(comment => {
                                const commentUser = userMap[comment.username] || {
                                    profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'
                                };
                                return `
                                    <div class="flex items-start">
                                        <img src="${commentUser.profilePic}" alt="${comment.username}" class="w-8 h-8 rounded-full mr-2">
                                        <div class="bg-white/10 p-2 rounded flex-1">
                                            <span class="font-semibold cursor-pointer" onclick="loadUserProfile('${comment.username}'); closeModal('postModal');">${comment.username}:</span> ${comment.text}
                                        </div>
                                    </div>
                                `;
                            }).join('') : '<p class="text-center text-gray-500">No comments yet</p>'}
                        </div>
                        
                        <div class="flex mt-4">
                            <input type="text" placeholder="Add a comment..." id="modal-comment-input-${post._id}"
                                class="clay-input flex-1 rounded-r-none">
                            <button onclick="addModalComment('${post._id}')"
                                class="clay-button rounded-l-none">Post</button>
                        </div>
                    `;
                    
                    openModal('postModal');
                }
            } catch (error) {
                console.error('Post detail error:', error);
                alert('Failed to load post details. Please try again.');
            }
            hideLoading();
        }

        async function addModalComment(postId) {
            showLoading();
            const commentText = document.getElementById(`modal-comment-input-${postId}`).value;
            
            if(!commentText.trim()) {
                hideLoading();
                return;
            }
            
            try {
                // Moderate comment
                const moderationResult = await moderateContent(commentText);
                
                if (!moderationResult.safe) {
                    showContentWarning(moderationResult.reason);
                    hideLoading();
                    return;
                }
                
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'posts',
                        conditions: { _id: postId }
                    })
                });

                const data = await response.json();
                if(data.success && data.result.length > 0) {
                    const post = data.result[0];
                    const comments = post.comments || [];
                    comments.push({
                        username: currentUser.username,
                        text: commentText,
                        timestamp: new Date().toISOString()
                    });

                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'posts',
                            conditions: { _id: postId },
                            data: { comments }
                        })
                    });

                    // Add notification for the post owner if it's not the current user
                    if(post.username !== currentUser.username) {
                        await addNotification(post.username, 'comment', currentUser.username, postId);
                    }

                    // Refresh the post modal
                    showPostDetail(postId);
                }
            } catch (error) {
                console.error('Comment addition error:', error);
                alert('Failed to add comment. Please try again.');
            }
            hideLoading();
        }

        // Notifications
        async function addNotification(toUsername, type, fromUsername, postId = null) {
            try {
                // Get user
                const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { username: toUsername }
                    })
                });

                const userData = await userResponse.json();
                if(userData.success && userData.result.length > 0) {
                    const user = userData.result[0];
                    const notifications = user.notifications || [];
                    
                    notifications.unshift({
                        type,
                        fromUsername,
                        postId,
                        timestamp: new Date().toISOString(),
                        read: false
                    });
                    
                    // Keep only the 50 most recent notifications
                    if(notifications.length > 50) {
                        notifications.length = 50;
                    }
                    
                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'users',
                            conditions: { username: toUsername },
                            data: { notifications }
                        })
                    });
                }
            } catch (error) {
                console.error('Notification error:', error);
            }
        }

        async function loadNotifications() {
            showLoading();
            try {
                // Reload current user data to get latest notifications
                const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'users',
                        conditions: { _id: currentUser._id }
                    })
                });

                const userData = await userResponse.json();
                if(userData.success && userData.result.length > 0) {
                    currentUser = userData.result[0];
                    
                    // Get userMap for profile pics
                    const userMap = {};
                    const fromUsernames = [...new Set((currentUser.notifications || []).map(n => n.fromUsername))];
                    
                    for(let username of fromUsernames) {
                        const fromUserResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                            method: 'POST',
                            headers: {
                                'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                appSlug,
                                action: 'read',
                                collection: 'users',
                                conditions: { username }
                            })
                        });

                        const fromUserData = await fromUserResponse.json();
                        if(fromUserData.success && fromUserData.result.length > 0) {
                            userMap[username] = fromUserData.result[0];
                        } else {
                            userMap[username] = {
                                profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'
                            };
                        }
                    }
                    
                    const notificationsContainer = document.getElementById('notificationsContainer');
                    notificationsContainer.innerHTML = '';
                    
                    if(!currentUser.notifications || currentUser.notifications.length === 0) {
                        notificationsContainer.innerHTML = '<p class="text-center py-4">No notifications yet</p>';
                    } else {
                        currentUser.notifications.forEach(notification => {
                            const fromUser = userMap[notification.fromUsername] || {
                                profilePic: 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'
                            };
                            
                            const timeAgo = formatTimeAgo(new Date(notification.timestamp));
                            
                            let message = '';
                            let action = '';
                            
                            if(notification.type === 'like') {
                                message = 'liked your post';
                                action = notification.postId ? `onclick="showPostDetail('${notification.postId}')"` : '';
                            } else if(notification.type === 'comment') {
                                message = 'commented on your post';
                                action = notification.postId ? `onclick="showPostDetail('${notification.postId}')"` : '';
                            } else if(notification.type === 'follow') {
                                message = 'started following you';
                                action = `onclick="loadUserProfile('${notification.fromUsername}')"`;
                            }
                            
                            const notificationEl = document.createElement('div');
                            notificationEl.className = `notification ${notification.read ? '' : 'bg-pink-50'} cursor-pointer`;
                            notificationEl.innerHTML = `
                                <img src="${fromUser.profilePic}" alt="${notification.fromUsername}" class="user-profile-image mr-3">
                                <div class="flex-1">
                                    <p><span class="font-semibold">${notification.fromUsername}</span> ${message}</p>
                                    <p class="text-xs text-gray-500">${timeAgo}</p>
                                </div>
                            `;
                            notificationEl.addEventListener('click', () => {
                                // Mark as read
                                markNotificationAsRead(notification);
                                
                                // Handle action
                                if(notification.type === 'follow') {
                                    loadUserProfile(notification.fromUsername);
                                } else if(notification.postId) {
                                    showPostDetail(notification.postId);
                                }
                            });
                            notificationsContainer.appendChild(notificationEl);
                        });
                        
                        // Add a "Mark all as read" button if there are unread notifications
                        if(currentUser.notifications.some(n => !n.read)) {
                            const markAllBtn = document.createElement('button');
                            markAllBtn.className = 'clay-button w-full mt-4';
                            markAllBtn.textContent = 'Mark all as read';
                            markAllBtn.addEventListener('click', markAllNotificationsAsRead);
                            notificationsContainer.appendChild(markAllBtn);
                        }
                    }
                }
            } catch (error) {
                console.error('Notifications loading error:', error);
                alert('Failed to load notifications. Please try again.');
            }
            hideLoading();
        }

        async function markNotificationAsRead(notification) {
            try {
                // Find the notification in currentUser's notifications
                const notificationIndex = currentUser.notifications.findIndex(
                    n => n.fromUsername === notification.fromUsername && 
                         n.timestamp === notification.timestamp &&
                         n.type === notification.type
                );
                
                if(notificationIndex !== -1) {
                    currentUser.notifications[notificationIndex].read = true;
                    
                    await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'update',
                            collection: 'users',
                            conditions: { _id: currentUser._id },
                            data: { notifications: currentUser.notifications }
                        })
                    });
                }
            } catch (error) {
                console.error('Notification read error:', error);
            }
        }

        async function markAllNotificationsAsRead() {
            showLoading();
            try {
                currentUser.notifications.forEach(notification => {
                    notification.read = true;
                });
                
                await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'update',
                        collection: 'users',
                        conditions: { _id: currentUser._id },
                        data: { notifications: currentUser.notifications }
                    })
                });
                
                loadNotifications();
            } catch (error) {
                console.error('Mark all as read error:', error);
                alert('Failed to mark notifications as read. Please try again.');
            }
            hideLoading();
        }

        // Explore
        async function loadExploreGrid() {
            showLoading();
            try {
                const response = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        appSlug,
                        action: 'read',
                        collection: 'posts',
                        conditions: { mediaUrl: { $ne: "" } }
                    })
                });

                const data = await response.json();
                if(data.success) {
                    const exploreGrid = document.getElementById('exploreGrid');
                    exploreGrid.innerHTML = '';
                    
                    const posts = data.result;
                    
                    // Randomize posts for explore
                    posts.sort(() => 0.5 - Math.random());
                    
                    posts.forEach(post => {
                        if(post.mediaUrl) {
                            const postEl = document.createElement('div');
                            postEl.className = 'grid-item cursor-pointer';
                            postEl.onclick = () => showPostDetail(post._id);
                            
                            if(post.mediaType === 'image') {
                                postEl.innerHTML = `<img src="${post.mediaUrl}" alt="Post">`;
                            } else {
                                postEl.innerHTML = `
                                    <video>
                                        <source src="${post.mediaUrl}" type="video/mp4">
                                    </video>
                                    <i class="bi bi-play-fill absolute inset-0 flex items-center justify-center text-4xl text-white"></i>
                                `;
                            }
                            exploreGrid.appendChild(postEl);
                        }
                    });
                    
                    if(posts.length === 0) {
                        exploreGrid.innerHTML = '<p class="text-center py-4">No posts to explore yet</p>';
                    }
                }
            } catch (error) {
                console.error('Explore grid error:', error);
                alert('Failed to load explore content. Please try again.');
            }
            hideLoading();
        }

        // Stories
        async function loadStories() {
            try {
                // Get users the current user is following
                const following = currentUser.following || [];
                if(following.length === 0) return;
                
                const storiesContainer = document.getElementById('storiesContainer');
                storiesContainer.innerHTML = '';
                
                for(let username of following.slice(0, 10)) { // Limit to 10 stories
                    const userResponse = await fetch('https://r0c8kgwocscg8gsokogwwsw4.zetaverse.one/mongodb', {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer cR0B7wyVLcbjtIyuwRyQp7R3y2r2',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            appSlug,
                            action: 'read',
                            collection: 'users',
                            conditions: { username }
                        })
                    });

                    const userData = await userResponse.json();
                    if(userData.success && userData.result.length > 0) {
                        const user = userData.result[0];
                        
                        const storyEl = document.createElement('div');
                        storyEl.className = 'story';
                        storyEl.innerHTML = `
                            <div class="story-avatar cursor-pointer" onclick="loadUserProfile('${username}')">
                                <img src="${user.profilePic || 'https://images.unsplash.com/photo-1513721032312-6a18a42c8763?w=152&h=152&fit=crop&crop=faces'}" alt="${username}">
                            </div>
                            <p class="text-xs">${username.length > 10 ? username.substring(0, 8) + '...' : username}</p>
                        `;
                        storiesContainer.appendChild(storyEl);
                    }
                }
            } catch (error) {
                console.error('Stories loading error:', error);
            }
        }

        // Helper Functions
        function formatTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffSec = Math.floor(diffMs / 1000);
            const diffMin = Math.floor(diffSec / 60);
            const diffHour = Math.floor(diffMin / 60);
            const diffDay = Math.floor(diffHour / 24);
            
            if(diffSec < 60) {
                return "just now";
            } else if(diffMin < 60) {
                return `${diffMin}m ago`;
            } else if(diffHour < 24) {
                return `${diffHour}h ago`;
            } else if(diffDay < 7) {
                return `${diffDay}d ago`;
            } else {
                const options = { year: 'numeric', month: 'short', day: 'numeric' };
                return date.toLocaleDateString(undefined, options);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Close modals when clicking outside of content
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if(e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            });
        });
    </script>
<script>document.body.addEventListener('wheel', e => { if (!e.ctrlKey) return; e.preventDefault(); return }, { passive: false })</script>
	</body>
</html>